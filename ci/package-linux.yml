when:
  - event: release
  - event: manual

steps:
  package-dist:
    image: ncollectd/ci-fedora:43
    commands:
      - cmake -B package-dist -S .
      - cmake --build package-dist -- dist
      - VERSION=`git describe --tags --match "v*" | sed -r 's/^v//;s/-([0-9]+)-g([a-f0-9]+)$/+\1.g\2/g'`
      - echo "VERSION=$${VERSION}" > package-dist/envvars
  package-fedora-43:
    image: ncollectd/ci-fedora:43
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - mkdir -p package-fedora-43/SOURCES
      - cp packaging/fedora/init.d-ncollectd package-fedora-43/SOURCES
      - cp packaging/fedora/systemd.ncollectd.service package-fedora-43/SOURCES
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-fedora-43/SOURCES
      - rpmbuild --define "_topdir `pwd`/package-fedora-43" --define "bundle_version $${VERSION}" -ba packaging/fedora/ncollectd.spec
  package-fedora-rawhide:
    image: ncollectd/ci-fedora:rawhide
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - mkdir -p package-fedora-rawhide/SOURCES
      - cp packaging/fedora/init.d-ncollectd package-fedora-rawhide/SOURCES
      - cp packaging/fedora/systemd.ncollectd.service package-fedora-rawhide/SOURCES
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-fedora-rawhide/SOURCES
      - rpmbuild --define "_topdir `pwd`/package-fedora-rawhide" --define "bundle_version $${VERSION}" -ba packaging/fedora/ncollectd.spec
  package-rockylinux-8:
    image: ncollectd/ci-rockylinux:8
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - mkdir -p package-rockylinux-8/SOURCES
      - cp packaging/fedora/init.d-ncollectd package-rockylinux-8/SOURCES
      - cp packaging/fedora/systemd.ncollectd.service package-rockylinux-8/SOURCES
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-rockylinux-8/SOURCES
      - rpmbuild --define "_topdir `pwd`/package-rockylinux-8" --define "bundle_version $${VERSION}" -ba packaging/fedora/ncollectd.spec
      - rm -rf package-rockylinux-8/BUILD
  package-rockylinux-9:
    image: ncollectd/ci-rockylinux:9
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - mkdir -p package-rockylinux-9/SOURCES
      - cp packaging/fedora/init.d-ncollectd package-rockylinux-9/SOURCES
      - cp packaging/fedora/systemd.ncollectd.service package-rockylinux-9/SOURCES
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-rockylinux-9/SOURCES
      - rpmbuild --define "_topdir `pwd`/package-rockylinux-9" --define "bundle_version $${VERSION}" -ba packaging/fedora/ncollectd.spec
      - rm -rf package-rockylinux-9/BUILD
  package-rockylinux-10:
    image: ncollectd/ci-rockylinux:10
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - mkdir -p package-rockylinux-10/SOURCES
      - cp packaging/fedora/init.d-ncollectd package-rockylinux-10/SOURCES
      - cp packaging/fedora/systemd.ncollectd.service package-rockylinux-10/SOURCES
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-rockylinux-10/SOURCES
      - rpmbuild --define "_topdir `pwd`/package-rockylinux-10" --define "bundle_version $${VERSION}" -ba packaging/fedora/ncollectd.spec
  package-debian-bookworm:
    image: ncollectd/ci-debian:bookworm
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - PKGVERSION=`echo $${VERSION} | sed -r 's/-rc/~pre/;s/\+([0-9]+)\.g([a-f0-9]+)$/+git\1.\2/'`
      - mkdir -p package-debian-bookworm
      - tar -C package-debian-bookworm -xJf package-dist/ncollectd-$${VERSION}.tar.xz
      - mv package-debian-bookworm/ncollectd-$${VERSION} package-debian-bookworm/ncollectd-$${PKGVERSION}
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-debian-bookworm/ncollectd_$${PKGVERSION}.orig.tar.xz
      - cp -r packaging/debian package-debian-bookworm/ncollectd-$${PKGVERSION}/
      - cd package-debian-bookworm/ncollectd-$${PKGVERSION}
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/changelog
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/NEWS
      - dpkg-buildpackage
      - cd ..
      - rm -rf ncollectd-$${PKGVERSION}
  package-debian-trixie:
    image: ncollectd/ci-debian:trixie
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - PKGVERSION=`echo $${VERSION} | sed -r 's/-rc/~pre/;s/\+([0-9]+)\.g([a-f0-9]+)$/+git\1.\2/'`
      - mkdir -p package-debian-trixie
      - tar -C package-debian-trixie -xJf package-dist/ncollectd-$${VERSION}.tar.xz
      - mv package-debian-trixie/ncollectd-$${VERSION} package-debian-trixie/ncollectd-$${PKGVERSION}
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-debian-trixie/ncollectd_$${PKGVERSION}.orig.tar.xz
      - cp -r packaging/debian package-debian-trixie/ncollectd-$${PKGVERSION}/
      - cd package-debian-trixie/ncollectd-$${PKGVERSION}
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/changelog
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/NEWS
      - sed -i '/libvarnishapi-dev/d' debian/control
      - rm -f debian/ncollectd-varnish.install
      - dpkg-buildpackage
      - cd ..
      - rm -rf ncollectd-$${PKGVERSION}
  package-debian-testing:
    image: ncollectd/ci-debian:testing
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - PKGVERSION=`echo $${VERSION} | sed -r 's/-rc/~pre/;s/\+([0-9]+)\.g([a-f0-9]+)$/+git\1.\2/'`
      - mkdir -p package-debian-testing
      - tar -C package-debian-testing -xJf package-dist/ncollectd-$${VERSION}.tar.xz
      - mv package-debian-testing/ncollectd-$${VERSION} package-debian-testing/ncollectd-$${PKGVERSION}
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-debian-testing/ncollectd_$${PKGVERSION}.orig.tar.xz
      - cp -r packaging/debian package-debian-testing/ncollectd-$${PKGVERSION}/
      - cd package-debian-testing/ncollectd-$${PKGVERSION}
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/changelog
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/NEWS
      - dpkg-buildpackage
      - cd ..
      - rm -rf ncollectd-$${PKGVERSION}
  package-ubuntu-jammy:
    image: ncollectd/ci-ubuntu:jammy
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - PKGVERSION=`echo $${VERSION} | sed -r 's/-rc/~pre/;s/\+([0-9]+)\.g([a-f0-9]+)$/+git\1.\2/'`
      - mkdir -p package-ubuntu-jammy
      - tar -C package-ubuntu-jammy -xJf package-dist/ncollectd-$${VERSION}.tar.xz
      - mv package-ubuntu-jammy/ncollectd-$${VERSION} package-ubuntu-jammy/ncollectd-$${PKGVERSION}
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-ubuntu-jammy/ncollectd_$${PKGVERSION}.orig.tar.xz
      - cp -r packaging/debian package-ubuntu-jammy/ncollectd-$${PKGVERSION}/
      - cd package-ubuntu-jammy/ncollectd-$${PKGVERSION}
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/changelog
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/NEWS
      - dpkg-buildpackage
      - cd ..
      - rm -rf ncollectd-$${PKGVERSION}
  package-ubuntu-noble:
    image: ncollectd/ci-ubuntu:noble
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - PKGVERSION=`echo $${VERSION} | sed -r 's/-rc/~pre/;s/\+([0-9]+)\.g([a-f0-9]+)$/+git\1.\2/'`
      - mkdir -p package-ubuntu-noble
      - tar -C package-ubuntu-noble -xJf package-dist/ncollectd-$${VERSION}.tar.xz
      - mv package-ubuntu-noble/ncollectd-$${VERSION} package-ubuntu-noble/ncollectd-$${PKGVERSION}
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-ubuntu-noble/ncollectd_$${PKGVERSION}.orig.tar.xz
      - cp -r packaging/debian package-ubuntu-noble/ncollectd-$${PKGVERSION}/
      - cd package-ubuntu-noble/ncollectd-$${PKGVERSION}
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/changelog
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/NEWS
      - dpkg-buildpackage
      - cd ..
      - rm -rf ncollectd-$${PKGVERSION}
  package-ubuntu-devel:
    image: ncollectd/ci-ubuntu:devel
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - PKGVERSION=`echo $${VERSION} | sed -r 's/-rc/~pre/;s/\+([0-9]+)\.g([a-f0-9]+)$/+git\1.\2/'`
      - mkdir -p package-ubuntu-devel
      - tar -C package-ubuntu-devel -xJf package-dist/ncollectd-$${VERSION}.tar.xz
      - mv package-ubuntu-devel/ncollectd-$${VERSION} package-ubuntu-devel/ncollectd-$${PKGVERSION}
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-ubuntu-devel/ncollectd_$${PKGVERSION}.orig.tar.xz
      - cp -r packaging/debian package-ubuntu-devel/ncollectd-$${PKGVERSION}/
      - cd package-ubuntu-devel/ncollectd-$${PKGVERSION}
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/changelog
      - sed -i '1s/^ncollectd (0.0.0-1)/ncollectd ('$${PKGVERSION}'-1)/' debian/NEWS
      - dpkg-buildpackage
      - cd ..
      - rm -rf ncollectd-$${PKGVERSION}
  package-archlinux-base-devel:
    image: ncollectd/ci-archlinux:base-devel
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - mkdir -p package-archlinux-base-devel
      - cp packaging/archlinux/service package-archlinux-base-devel/
      - cp packaging/archlinux/PKGBUILD package-archlinux-base-devel/
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-archlinux-base-devel/
      - cd package-archlinux-base-devel
      - sed -i 's/^pkgver=.*$/pkgver='$${VERSION}'/' PKGBUILD
      - makepkg --skipchecksums
      - rm -rf src pkg
      - cd ..
  package-opensuse-leap:
    image: ncollectd/ci-opensuse:leap
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - mkdir -p package-opensuse-leap/SOURCES
      - cp packaging/opensuse/systemd.ncollectd.service package-opensuse-leap/SOURCES
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-opensuse-leap/SOURCES
      - rpmbuild --define "_topdir `pwd`/package-opensuse-leap" --define "bundle_version $${VERSION}" -ba packaging/opensuse/ncollectd.spec
      - rm -rf package-opensuse-leap/BUILD
  package-opensuse-tumbleweed:
    image: ncollectd/ci-opensuse:tumbleweed
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - mkdir -p package-opensuse-tumbleweed/SOURCES
      - cp packaging/opensuse/systemd.ncollectd.service package-opensuse-tumbleweed/SOURCES
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-opensuse-tumbleweed/SOURCES
      - rpmbuild --define "_topdir `pwd`/package-opensuse-tumbleweed" --define "bundle_version $${VERSION}" -ba packaging/opensuse/ncollectd.spec
  package-alpine-edge:
    image: ncollectd/ci-alpine:edge
    commands:
      - . ./package-dist/envvars
      - export GIT_DIR=.do-not-find-it
      - PKGVERSION=`echo $${VERSION} | sed -r 's/-rc/_rc/;s/\+([0-9]+)\.g([a-f0-9]+)$/_git\1/'`
      - mkdir -p package-alpine-edge
      - cp packaging/alpine/ncollectd.pre-install package-alpine-edge/
      - cp packaging/alpine/ncollectd.initd package-alpine-edge/
      - cp packaging/alpine/APKBUILD package-alpine-edge/
      - cp package-dist/ncollectd-$${VERSION}.tar.xz package-alpine-edge/
      - echo "permit nopass :wheel as root" > /etc/doas.d/doas.conf
      - echo "REPODEST=$${CI_WORKSPACE}/package-alpine-edge/packages/" >> /etc/abuild.conf
      - cd package-alpine-edge
      - sed -i 's/^_pkgver=.*$/_pkgver='$${VERSION}'/' APKBUILD
      - sed -i 's/^pkgver=.*$/pkgver='$${PKGVERSION}'/' APKBUILD
      - abuild -F checksum
      - abuild-keygen -a -i -n
      - abuild -F -r
      - cd ..
