.\" SPDX-License-Identifier: GPL-2.0-only
.Dd @NCOLLECTD_DATE@
.Dt NCOLLECTD-MYSQL 5
.Os ncollectd @NCOLLECTD_VERSION@
.Sh NAME
.Nm ncollectd-mysql
.Nd Documentation of ncollectd's mysql plugin
.Sh SYNOPSIS
.Bd -literal -compact
\fBload-plugin\fP mysql
\fBplugin\fP mysql {
    \fBquery\fP \fIquery-name\fP {
        \fBstatement\fP \fIsql\fP
        \fBmin-version\fP \fIversion\fP
        \fBmax-version\fP \fIversion\fP
        \fBmetric-prefix\fP \fIprefix\fP
        \fBlabel\fP \fIkey\fP \fIvalue\fP
        \fBlabel-from\fP \fIkey\fP \fIcolumn-name\fP
        \fBresult\fP {
            \fBtype\fP \fIgauge|counter|info|unknow\fP
            \fBtype-from\fP \fIcolumn-name\fP
            \fBhelp\fP \fIhelp\fP
            \fBhelp-from\fP \fIcolumn-name\fP
            \fBmetric\fP \fImetric-name\fP
            \fBmetric-prefix\fP \fI prefix\fP
            \fBmetric-from\fP \fIcolumn-name\fP
            \fBlabel\fP \fIkey\fP \fIvalue\fP
            \fBlabel-from\fP \fIkey\fP \fIcolumn-name\fP
            \fBvalue-from\fP \fIcolumn-name\fP
        }
    }
    \fBinstance\fP \fIname\fP {
        \fBhost\fP \fIhostname\fP
        \fBuser\fP \fIusername\fP
        \fBuser-env\fP \fIenv-name\fP
        \fBpassword\fP \fIpassword\fP
        \fBpassword-env\fP \fIenv-name\fP
        \fBport\fP \fIport\fP
        \fBsocket\fP \fIsocket-path\fP
        \fBdatabase\fP \fIdatabase\fP
        \fBssl-key\fP "\fI/path/to/key.pem\fP"
        \fBssl-cert\fP "\fI/path/to/cert.pem\fP"
        \fBssl-ca\fP "\fI/path/to/ca.pem\fP"
        \fBssl-ca-path\fP "\fI/path/to/cas/\fP"
        \fBssl-cipher\fP \fIcyphers\fP
        \fBconnect-timeout\fP \fIseconds\fP
        \fBheartbeat-utc\fP  \fItrue|false\fP
        \fBheartbeat-schema\fP \fIschema\fP
        \fBheartbeat-table\fP \fItable\fP
        \fBinterval\fP \fIseconds\fP
        \fBcollect\fP \fIflags\fP ...
        \fBmetric-prefix\fP \fIprefix\fP
        \fBlabel\fP \fIkey\fP \fIvalue\fP
        \fBquery\fP \fIquery-name\fP
        \fBfilter\fP {
            ...
        }
    }
}
.Ed
.Sh DESCRIPTION
The \fBmysql\fP plugin requires \fBmysqlclient\fP to be installed.
It connects to one or more databases when started and keeps the connection
up as long as possible.
When the connection is interrupted for whatever reason it will try
to re-connect.
The plugin will complain loudly in case anything goes wrong.
.Bl -tag -width Ds
.It \fBinstance\fP \fIname\fP
A \fBinstance\fP block defines one connection to a MySQL database.
It accepts a single argument which specifies the name of the database.
None of the other options are required.
MySQL will use default values as documented in the
\f(CWmysql_real_connect()\fP and \f(CWmysql_ssl_set()\fP sections in the
\fBMySQL reference manual\fP.
Each database needs a \fIinstance-name\fP as string argument in the starting
tag of the block.
.Bl -tag -width Ds
.It \fBhost\fP \fIhostname\fP
Hostname of the database server.
Defaults to \fBlocalhost\fP.
.It \fBuser\fP \fIusername\fP
Username to use when connecting to the database.
The user does not have to be granted any privileges
(which is synonym to granting the \f(CWUSAGE\fP privilege),
unless you want to collect replication statistics.
.It \fBuser-env\fP \fIenv-name\fP
Get the username to use when connecting to the database from the environment
variable \fIenv-name\fP.
.It \fBpassword\fP \fIpassword\fP
Password needed to log into the database.
.It \fBpassword-env\fP \fIenv-name\fP
Get the password needed to log into the database from the environment
variable \fIenv-name\fP.
.It \fBport\fP \fIport\fP
TCP-port to connect to.
If \fBhost\fP is set to \fBlocalhost\fP (the default), this setting
has no effect.
See the documentation for the \f(CWmysql_real_connect\fP function for details.
.It \fBsocket\fP \fIsocket-path\fP
Specifies the path to the UNIX domain socket of the MySQL server.
This option only has any effect, if \fBhost\fP is set to
\fBlocalhost\fP (the default).
Otherwise, use the \fBport\fP option above.
See the documentation for the
\f(CWmysql_real_connect\fP function for details.
.It \fBdatabase\fP \fIdatabase\fP
Select this database.
Defaults to \fIno database\fP which is a perfectly reasonable
option for what this plugin does.
.It \fBssl-key\fP "\fI/path/to/key.pem\fP"
If provided, the X509 key in PEM format.
.It \fBssl-cert\fP "\fI/path/to/cert.pem\fP"
If provided, the X509 cert in PEM format.
.It \fBssl-ca\fP "\fI/path/to/ca.pem\fP"
If provided, the CA file in PEM format (check OpenSSL docs).
.It \fBssl-ca-path\fP "\fI/path/to/cas/\fP"
If provided, the CA directory (check OpenSSL docs).
.It \fBssl-cipher\fP \fIcyphers\fP
If provided, the SSL cipher to use.
.It \fBconnect-timeout\fP \fIseconds\fP
Sets the connect timeout for the MySQL client.
.It \fBheartbeat-utc\fP  \fItrue|false\fP
Use UTC for timestamps of the current server.
Defauilt if \fIfalse\fP.
.It \fBheartbeat-schema\fP \fIschema\fP
Schema from where to collect heartbeat data.
Default is \fIheartbeat\fP.
.It \fBheartbeat-table\fP \fItable\fP
Table from where to collect heartbeat data.
Default is \fIheartbeat\fP.
.It \fBinterval\fP \fIseconds\fP
Sets the interval (in seconds) in which the values will be
collected from this database.
.It \fBcollect\fP \fIflags\fP ...
.Bl -tag -width Ds
.It \fBglobals\fP
Collect global values from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBacl\fP
Collect \f(CWAcl_*\fP values from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBaria\fP
Collect \f(CWAria_*\fP values from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBbinlog\fP
Collect \f(CWBinlog_*\fP values from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBcommands\fP
Collect \f(CWCom_*\fP values from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBfeatures\fP
Collect \f(CWFeature_*\fP values from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBhandlers\fP
Collect \f(CWHandler_*\fP values from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBinnodb\fP
Collect values from \f(CWINFORMATION_SCHEMA.INNODB_METRICS\fP table.
.It \fBinnodb_cmp\fP
Collect values from \f(CWINFORMATION_SCHEMA.INNODB_CMPMEM\fP table.
.It \fBinnodb_cmpmem\fP
Collect values from \f(CWINFORMATION_SCHEMA.INNODB_CMP\fP table.
.It \fBinnodb_tablespace\fP
Collect values from \f(CWINFORMATION_SCHEMA.INNODB_SYS_TABLESPACES\fP table.
.It \fBmyisam\fP
Collect \f(CWKey_*\fP values from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBperfomance_lost\fP
Collect \f(CWPerformance_schema_*\fP values
from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBqcache\fP
Collect \f(CWQcache_*\fP values from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBslave\fP
Collect \f(CWSlave*\fP values from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBssl\fP
Collect \f(CWSsl_*\fP values from \f(CWSHOW GLOBAL STATUS\fP command.
.It \fBwsrep\fP
Enable the collection of wsrep plugin statistics, used in Master-Master
replication setups like in MySQL Galera/Percona XtraDB Cluster.
User needs only privileges to execute 'SHOW GLOBAL STATUS'.
Defaults to \fBfalse\fP.
.It \fBclient\fP
Collect values from \f(CWINFORMATION_SCHEMA.CLIENT_STATISTICS\fP table.
.It \fBuser\fP
Collect values from \f(CWINFORMATION_SCHEMA.USER_STATISTICS\fP table.
.It \fBindex\fP
Collect values from \f(CWINFORMATION_SCHEMA.INDEX_STATISTICS\fP table.
.It \fBtable\fP
Collect values from \f(CWINFORMATION_SCHEMA.TABLE_STATISTICS\fP table.
.It \fBtable\fP
Collect values from \f(CWINFORMATION_SCHEMA.TABLES\fP table.
.It \fBresponse_time\fP
Collect values from \f(CWINFORMATION_SCHEMA.QUERY_RESPONSE_TIME\fP table.
In Percona server collect values fron
\f(CWINFORMATION_SCHEMA.QUERY_RESPONSE_TIME_READ\fP
and \f(CWINFORMATION_SCHEMA.QUERY_RESPONSE_TIME_WRITE\fP and table.
.It \fBmaster\fP
.It \fBslave\fP
Enable the collection of primary / replica statistics in a replication setup.
In order to be able to get access to these statistics, the user needs special
privileges.
.It \fBheartbeat\fP
Collect replication delay measured by a heartbeat mechanism.
The reference implementation supported is \fBpt-heartbeat\fP.
You can control the table name with \fBheartbeat-schema\fP
and \fBheartbeat-table\fP options.
The heartbeat table must have at least this two columns:
.Bd -literal
  CREATE TABLE heartbeat (
      ts        varchar(26)  NOT NULL,
      server_id int unsigned NOT NULL PRIMARY KEY,
  );
.Ed
.El
.It \fBmetric-prefix\fP \fIprefix\fP
Prepends \fIprefix\fP to the metrics name.
.It \fBlabel\fP \fIkey\fP \fIvalue\fP
Append the label \fIkey\fP=\fIvalue\fP to the submitting metrics.
Can appear multiple time in the \fBdatabase\fP block.
.It \fBquery\fP \fIquery-name\fP
Associates the query named \fIquery-name\fP with this database connection.
The query needs to be defined \fIbefore\fP this statement, i. e. all query
blocks you want to refer to must be placed above the database block you want to
refer to them from.
.It \fBfilter\fP
Configure a filter to modify or drop the metrics.
See \fBFILTER CONFIGURATION\fP in
.Xr ncollectd.conf 5 .
.El
.It \fBquery\fP \fIquery-name\fP
Query blocks define \fISQL\fP statements and how the returned data should be
interpreted.
They are identified by the name that is given in the opening line of the block.
Thus the name needs to be unique.
Other than that, the name is not used in ncollectd.
.Pp
In each \fBquery\fP block, there is one or more \fBresult\fP blocks.
\fBresult\fP blocks define which column holds which value or instance
information.
You can use multiple \fBresult\fP blocks to create multiple values from one
returned row.
This is especially useful, when queries take a long time and sending almost
the same query again and again is not desirable.
.Bl -tag -width Ds
.It \fBstatement\fP \fIsql\fP
Sets the statement that should be executed on the server.
This is \fBnot\fP interpreted by ncollectd, but simply passed to the
database server.
Therefore, the SQL dialect that's used depends on the server collectd
is connected to.
.It \fBmin-version\fP \fIversion\fP
.It \fBmax-version\fP \fIversion\fP
Only use this query for the specified database version.
You can use these options to provide multiple queries with the same name
but with a slightly different syntax.
The plugin will use only those queries, where the specified
minimum and maximum versions fit the version of the database in use.
.It \fBmetric-prefix\fP \fIprefix\fP
Prepends \fIprefix\fP to the metrics name.
.It \fBlabel\fP \fIkey\fP \fIvalue\fP
Append the label \fIkey\fP=\fIvalue\fP to the submitting metrics.
Can appear multiple time in the \fBquery\fP block.
.It \fBlabel-from\fP \fIkey\fP \fIcolumn-name\fP
Specifies the columns whose values will be used to create the labels.
.It \fBresult\fP
.Bl -tag -width Ds
.It \fBtype\fP \fIgauge|counter|info|unknow\fP
The \fBtype\fP that's used for each line returned.
Must be \fIgauge\fP, \fIcounter\fP, \fIinfo\fP or \fPunknow\fP.
If not set is \fPunknow\fP.
There must be exactly one \fBtype\fP option inside each \fBresult\fP block.
.It \fBtype-from\fP \fIcolumn-name\fP
Read the type from \fIcolumn\fP.
The column value must be \fIgauge\fP, \fIcounter\fP, \fIinfo\fP or \fPunknow\fP.
.It \fBhelp\fP \fIhelp\fP
Set the \fBhelp\fP text for the metric.
.It \fBhelp-from\fP \fIcolumn-name\fP
Read the \fBhelp\fP text for the the metric from the named column.
.It \fBmetric\fP \fImetric-name\fP
Set the metric name.
.It \fBmetric-prefix\fP \fI prefix\fP
Prepends \fIprefix\fP to the metric name in the \fBresult\fP.
.It \fBmetric-from\fP \fIcolumn-name\fP
Read the metric name from the named column.
There must be at least one \fBmetric\fP or \fBmetric-from\fP option inside
each \fBresult\fP block.
.It \fBlabel\fP \fIkey\fP \fIvalue\fP
Append the label \fIkey\fP=\fIvalue\fP to the submitting metrics.
Can appear multiple times in the \fBresult\fP block.
.It \fBlabel-from\fP \fIkey\fP \fIcolumn-name\fP
Specifies the columns whose values will be used to create the labels.
.It \fBvalue-from\fP \fIcolumn-name\fP
Name of the column whose content is used as the actual data for the metric
that are dispatched to the daemon.
There must be only one \fBvalue-from\fP option inside each \fBresult\fP block.
.El
.El
.El
.Sh "SEE ALSO"
.Xr ncollectd 1 ,
.Xr ncollectd.conf 5
