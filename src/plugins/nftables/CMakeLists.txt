plugin_option(PLUGIN_NFTABLES "nftables rules statistics" ON)

include(CheckEnumExists)

set(BUILD_PLUGIN_NFTABLES 0)

if(PLUGIN_NFTABLES)
    find_package(LibNftnl)
    if(BUILD_LINUX)
        if (LIBNFTNL_FOUND)
            check_enum_exists(NFTNL_UDATA_RULE_COMMENT "libnftnl/udata.h" HAVE_NFTNL_UDATA_RULE_COMMENT)
       if(HAVE_NFTNL_UDATA_RULE_COMMENT)
                set(BUILD_PLUGIN_NFTABLES 1)
        else()
        set(BUILD_PLUGIN_NFTABLES_REASON "NFTNL_UDATA_RULE_COMMENT not found" PARENT_SCOPE)
        endif()
        else()
            set(BUILD_PLUGIN_NFTABLES_REASON "libnftnl not found" PARENT_SCOPE)
        endif()
    else()
        set(BUILD_PLUGIN_NFTABLES_REASON "Linux only" PARENT_SCOPE)
    endif()
endif()

set(BUILD_PLUGIN_NFTABLES ${BUILD_PLUGIN_NFTABLES} PARENT_SCOPE)

if(BUILD_PLUGIN_NFTABLES)
    set(PLUGIN_NFTABLES_SRC nftables.c)
    add_library(nftables MODULE ${PLUGIN_NFTABLES_SRC})
    target_link_libraries(nftables PRIVATE libmetric libutils LibNftnl::LibNftnl)
    set_target_properties(nftables PROPERTIES PREFIX "")
    install(TARGETS nftables DESTINATION ${CMAKE_INSTALL_LIBDIR}/ncollectd/)
    configure_file(ncollectd-nftables.5 ncollectd-nftables.5 @ONLY)
    install(FILES ${CMAKE_CURRENT_BINARY_DIR}/ncollectd-nftables.5 DESTINATION ${CMAKE_INSTALL_MANDIR}/man5)
endif()
